name: celeste-android-port-ci

on:
  workflow_dispatch:
    inputs:
      package_format:
        description: "Formato do pacote Android"
        required: true
        default: "aab"
        type: choice
        options: [aab, apk]
      configuration:
        description: "Configuração do build"
        required: true
        default: "Release"
        type: choice
        options: [Release, Debug]

  push:
    branches: [ main ]

  pull_request:
    branches: [ main ]

concurrency:
  group: celeste-android-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  ANDROID_PROJECT: src/Celeste.Android/Celeste.Android.csproj
  ONLY_ALLOWED_TXT: "Relatorio.txt"

  DOTNET_SDK_VERSION: "10.0.102"
  JAVA_VERSION: "17"

  DOTNET_MULTILEVEL_LOOKUP: "0"
  DOTNET_NOLOGO: "1"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"

jobs:
  validate-repo:
    name: Validate repository rules
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate "only one .txt in repo" rule
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t txts < <(find . -type f -name "*.txt" -not -path "./.git/*" -not -path "./**/bin/*" -not -path "./**/obj/*" -print)
          allowed="./${ONLY_ALLOWED_TXT}"
          for f in "${txts[@]:-}"; do
            if [[ "$f" != "$allowed" ]]; then
              echo "::error ::Arquivo .txt não permitido no repo: $f (permitido apenas: $allowed)"
              exit 1
            fi
          done
          if [[ ! -f "$allowed" ]]; then
            echo "::error ::Relatorio.txt não encontrado na raiz do repo. Crie ./Relatorio.txt"
            exit 1
          fi

      - name: "Quick sanity: Android csproj exists"
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -f "${ANDROID_PROJECT}" ]]; then
            echo "::error ::Projeto Android não encontrado: ${ANDROID_PROJECT}"
            exit 1
          fi

  build:
    name: Build Android (APK/AAB, arm32+arm64)
    runs-on: ubuntu-latest
    needs: validate-repo

    env:
      CONFIGURATION: ${{ inputs.configuration || 'Release' }}
      PACKAGE_FORMAT: ${{ inputs.package_format || 'aab' }}

      ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Create/print global.json (pin SDK)
        shell: bash
        run: |
          set -euo pipefail
          cat > global.json <<EOF
          {
            "sdk": {
              "version": "${DOTNET_SDK_VERSION}",
              "rollForward": "disable",
              "allowPrerelease": false
            }
          }
          EOF
          echo "global.json:"
          cat global.json

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_SDK_VERSION }}
          cache: false

      - name: Verify toolchain
        shell: bash
        run: |
          set -euo pipefail
          echo "dotnet version:"
          dotnet --version
          ver="$(dotnet --version)"
          if [[ "$ver" != 10.* ]]; then
            echo "::error ::SDK inesperado: $ver (esperado 10.x)."
            exit 1
          fi
          dotnet --info
          echo "java version:"
          java -version

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/*.props', '**/*.targets', '**/NuGet.config') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Install Android workload
        shell: bash
        run: |
          set -euo pipefail
          dotnet workload install android
          dotnet workload list

      - name: Restore
        shell: bash
        run: |
          set -euo pipefail
          dotnet restore "${ANDROID_PROJECT}"

      - name: Build / Publish (generates APK/AAB)
        shell: bash
        run: |
          set -euo pipefail
          echo "Configuration: ${CONFIGURATION}"
          echo "PackageFormat: ${PACKAGE_FORMAT}"
          dotnet publish "${ANDROID_PROJECT}" \
            -c "${CONFIGURATION}" \
            --no-restore \
            -p:AndroidPackageFormat="${PACKAGE_FORMAT}" \
            -p:ContinuousIntegrationBuild=true \
            -p:Deterministic=true

      - name: Sign (optional) - only if keystore provided
        if: ${{ env.ANDROID_KEYSTORE_B64 != '' }}
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: src/Celeste.Android/bin/${{ env.CONFIGURATION }}/net10.0-android
          signingKeyBase64: ${{ env.ANDROID_KEYSTORE_B64 }}
          alias: ${{ env.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ env.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ env.ANDROID_KEY_PASSWORD }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: celeste-${{ env.PACKAGE_FORMAT }}-${{ env.CONFIGURATION }}
          if-no-files-found: error
          retention-days: 14
          path: |
            src/Celeste.Android/bin/${{ env.CONFIGURATION }}/**/*